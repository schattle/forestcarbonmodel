---
title: "Forest Carbon Model"
author: "Lizzy Schattle, Rich Viebrock, Haley Grant, & Pat Byrne"
date: "5/5/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# packages
library(tidyverse)
library(deSolve)
library(sensitivity)
```

Instructions

1. Implement this model in R (as a differential equation)

```{r part 1. implement model}

source("R/dexcarbon_play.R")

```


2. Run the model for 300 years (using the ODE solver) starting with an initial forest size of 10 kg/C, and using the following parameters

 canopy closure threshold of 50 kgC 
 K = 250 kg C (carrying capacity) 
 r = 0.01 (exponential growth rate before before canopy closure)
 g = 2 kg/year (linear growth rate after canopy closure)

Graph the results

```{r part 2. run the model using ODE solver}

# set the parameters

T = 300
C = 10
cc = 50
r = 0.01
K = 250
g = 2

pcompare = list(cc=cc, r=r, K=K, g=g)

dexcarbon_play(time = T, C = C, parms = pcompare)

growth_result = data.frame(time=seq(from=1,to=300))

carbon_result = ode(C, growth_result$time, dexcarbon_play, pcompare)
head(carbon_result)

```

3. Run a sobol sensitivity analysis that explores how the estimated maximum and mean forest size (e.g maximum and mean values of C over the 300 years) varies with the pre canopy closure growth rate (r) and post-canopy closure growth rate (g) and canopy closure threshold and carrying capacity(K)

Assume that they are all normally distributed with means as given above and standard deviation of 10% of mean value

Graph the results of the sensitivity analysis as a box plot of maximum forest size and a plot of the two sobol indices (S and T)

Submit R markdown with model implementation, graphs and sensitivity analysis and R file with your model


```{r part 3. sobel sensitivity analysis}

```


```{r sen}
source("../R/dexppop_play.R")

# lets start with sobel 
library(sensitivity)

# come up with first set of sample parameters
# we will assume that we know the initial population,

Pinitial=10

# want to learn about sensitivity to growth rate (r) and carrying capacity (K)
# set the number of parameters
np=100
K = rnorm(mean=400, sd=10, n=np)
r = rnorm(mean=0.02, sd=0.005, n=np)
X1 = cbind.data.frame(r=r, K=K)

# repeat to get our second set of samples
K = rnorm(mean=400, sd=20, n=np)
r = rnorm(mean=0.02, sd=0.005, n=np)
X2 = cbind.data.frame(r=r, K=K)

# create our sobel object and get sets ofparameters for running the model

sens_P = soboljansen(model = NULL,X1, X2, nboot = 300)

# our parameter sets are
head(sens_P$X)

# run our differential equation and keep the output
# BUT
# what output do we want  to keep
# how about maximum population if we run the model for 200 years, and how many years to get to the carrying capacity

# for illustration lets look at running just one parameter sets and summarizing results
sens_P$X[1,]
# recall ODE needs ALL of our parameters in a single list 
# initial population and timnes for which we want output 
Pinitial

# gets results for 200 years (evaluating every year)
simtimes = seq(from=1, to=200)
parms = list(r=sens_P$X$r[1], K=sens_P$X$K[1])
result = ode(y=Pinitial, times=simtimes, func=dexppop_play, parms=parms)

head(result)
colnames(result)=c("time","P")
# turn it into a data frame
result = as.data.frame(result)
ggplot(result, aes(time, P))+geom_point()

# extra our metrics of interest  from this
# maximum population it gets to
maxpop = max(result$P)
maxpop

# years required to get to the maximum poputation
# which.max will tell us when max population occur
idx = which.max(result$P)
# turn this index into a year (might be the same if time step in 1 but just in case it isn't)
maxyear = result$time[idx]
maxyear
```


